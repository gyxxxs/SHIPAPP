# 智能体知识库和模型诊断实现说明

## 📋 功能概述

本项目已成功集成以下功能：

1. **智能体知识库（RAG）**：基于向量数据库的语义检索系统
2. **深度学习模型诊断**：实时监控模型推理性能和准确率

## 🚀 安装步骤

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

**注意**：首次安装可能需要较长时间，因为需要下载：
- 嵌入模型（sentence-transformers，约500MB）
- PyTorch（根据系统自动选择CPU或GPU版本）

### 2. 运行应用

```bash
streamlit run zhinengti.py
```

首次运行时会自动：
- 初始化知识库（创建向量数据库并加载默认知识）
- 初始化深度学习模型（使用随机权重，可后续替换为训练好的模型）

## 📚 知识库（RAG）功能

### 功能特点

- ✅ 基于 ChromaDB 向量数据库
- ✅ 支持 PDF 和 TXT 文档加载
- ✅ 自动文档分割和向量化
- ✅ 语义相似度检索
- ✅ 动态检索，根据用户问题智能匹配相关知识

### 添加自定义文档

1. 创建 `knowledge_docs/` 目录（可选）
2. 将 PDF 或 TXT 文件放入该目录
3. 在代码中调用：

```python
from knowledge_base import KnowledgeBase

kb = KnowledgeBase()
kb.add_documents([
    "knowledge_docs/your_doc.pdf",
    "knowledge_docs/another_doc.txt"
])
```

### 知识库位置

- 向量数据库存储在：`./knowledge_db/` 目录
- 首次运行会自动创建并初始化默认知识

## 🤖 模型诊断功能

### 功能特点

- ✅ 实时监控推理延迟
- ✅ 追踪置信度趋势
- ✅ 记录预测分布统计
- ✅ 生成详细诊断报告
- ✅ 可视化性能指标

### 使用方式

1. **查看实时指标**：在侧边栏的"模型诊断"部分查看：
   - 总推理次数
   - 平均延迟（毫秒）
   - 平均置信度（%）

2. **查看详细报告**：点击"查看详细诊断报告"按钮，包括：
   - 模型状态和设备信息
   - 性能评估（延迟、置信度）
   - 最近10次推理的置信度趋势图
   - 最近100次预测的分布统计图

3. **导出报告**：点击"导出诊断报告"按钮，生成JSON格式的诊断报告

4. **重置统计**：点击"重置统计"按钮，清空历史记录

### 模型架构

当前使用的是 1D CNN 架构：
- 3层卷积层（32→64→128通道）
- 批归一化和Dropout正则化
- 4分类输出（正常/一级预警/二级预警/干扰信号）

### 替换为训练好的模型

如果有训练好的模型，可以：

1. 将模型文件放在 `models/` 目录
2. 修改 `model_diagnostics.py` 中的初始化：

```python
model_diagnostics = ModelDiagnostics(model_path="models/your_model.pth")
```

## 🔧 故障排除

### 问题1：导入模块失败

**症状**：控制台显示"导入模块失败"

**解决方案**：
- 确保已安装所有依赖：`pip install -r requirements.txt`
- 检查 Python 版本（建议 3.8+）

### 问题2：知识库初始化慢

**症状**：首次运行需要很长时间

**原因**：需要下载嵌入模型（约500MB）

**解决方案**：
- 首次运行需要网络连接
- 下载完成后会缓存，后续运行会很快

### 问题3：模型推理慢

**症状**：推理延迟较高（>50ms）

**解决方案**：
- 如果有GPU，PyTorch会自动使用
- 可以优化模型架构或减少输入长度
- 检查系统资源使用情况

### 问题4：RAG检索结果不准确

**解决方案**：
- 添加更多相关文档到知识库
- 调整检索数量（k参数）
- 检查文档质量和相关性

## 📊 性能指标

### 预期性能

- **推理延迟**：<20ms（CPU），<5ms（GPU）
- **知识库检索**：<100ms
- **模型准确率**：>90%（使用训练好的模型）

### 监控指标

系统会实时监控：
- 推理延迟（平均/最大/最小）
- 置信度趋势
- 预测分布
- 系统运行时间

## 🎯 下一步优化建议

1. **模型训练**：
   - 使用真实船舶电流数据训练模型
   - 优化模型架构以提高准确率
   - 实现模型版本管理

2. **知识库扩展**：
   - 添加更多技术文档
   - 实现文档版本控制
   - 支持多语言文档

3. **性能优化**：
   - 实现模型量化（减少模型大小）
   - 使用更快的嵌入模型
   - 实现缓存机制

4. **功能增强**：
   - 添加模型A/B测试
   - 实现自动模型重训练
   - 添加知识库更新通知

## 📝 文件结构

```
ship-monitor-app-main/
├── zhinengti.py              # 主应用文件
├── knowledge_base.py         # 知识库管理模块
├── model_diagnostics.py      # 模型诊断模块
├── requirements.txt          # 依赖列表
├── knowledge_db/             # 向量数据库（自动创建）
└── README_implementation.md # 本说明文档
```

## 🔐 注意事项

1. **API密钥**：确保在 `.streamlit/secrets.toml` 中配置了 Gemini API Key
2. **数据隐私**：知识库数据存储在本地，不会上传到云端
3. **模型安全**：如果使用训练好的模型，确保模型来源可信
4. **资源使用**：模型和知识库会占用一定内存，建议至少4GB RAM

## 📞 技术支持

如有问题，请检查：
1. 依赖是否正确安装
2. Python版本是否兼容（3.8+）
3. 系统资源是否充足
4. 网络连接是否正常（首次下载模型需要）

---

**版本**：1.0.0  
**更新日期**：2024年

